## Pratilipi Backend

Backend Repo for Pratilipi Assignment

## Getting started

This is a REST API written on JavaScript using async/await.

## Requirements Satisfied

[X] Signup with a username and password.

[X] Log in with User Id and password.

[X] A page for viewing all the stories titles, and clicking them should take to the story page.

[X] The story page should contain

-   the following details
    -   Story title
    -   Story content

[X] Number of people currently viewing this storyd) Total read count for the story

## Features

-   Multiple environment ready (development, production)
-   Custom email/password user system with basic security and rate limiting for preventing brute force attacks.
-   Compressed responses.
-   Secured HTTP headers.
-   CORS ready.
-   HTTP request logger in development mode.
-   User roles.
-   User profile.
-   Users list for admin area.
-   Login access log with IP, browser and country location (for country it looks for the header `cf-ipcountry` that CloudFlare creates when protecting your website).
-   API autogenerated documentation by Postman.
-   API collection example for Postman.
-   Testing with mocha/chai for API endpoints.
-   NPM scripts for cleaning and seeding the MongoDB database.
-   NPM script for keeping good source code formatting using prettier and ESLint.
-   Use of ESLint for good coding practices.
-   Ability to refresh token
-   JWT Tokens, make requests with a token after login with `Authorization` header with value `Bearer yourToken` where `yourToken` is the **signed and encrypted token** given in the response from the login process.

## Requirements

-   Node.js **10+**
-   MongoDB **3.6+**

### Login credentials

email: `admin@admin.com`
password: `12345`

## How to install

### Install npm dependencies after installing (Git or manual download)

```bash
cd myproject
npm install
npm update
```

## How to run

\---- VERY IMPORTANT ---

### Database cleaning and seeding samples

There are 3 available commands for this: `fresh`, `clean` and `seed`.

```bash
npm run command
```

-   `fresh` cleans and then seeds the database with dynamic data.
-   `clean` cleans the database.
-   `seed` seeds the database with dynamic data.

### Running in development mode (lifting API server)

```bash
npm run dev
```

You will know server is running by checking the output of the command `npm run dev`

```bash
****************************
*    Starting Server
*    Port: 3000
*    NODE_ENV: development
*    Database: MongoDB
*    DB Connection: OK
****************************
```

### API Usage

This is a REST API, so it works using the following HTTP methods:

-   GET (Read): Gets a list of items, or a single item
-   POST (Create): Creates an item
-   PATCH (Update): Updates an item
-   DELETE: Deletes an item

### Creating new models

If you need to add more models to the project just create a new file in `/app/models/` and it will be loaded dynamically.

### Creating new routes

If you need to add more routes to the project just create a new file in `/app/routes/` and it will be loaded dynamically.

### Creating new controllers

When you create a new controller file, try to also create another file with validations. Ex. `comments.js` and `comments.validate.js`.

## API Example Flow

Please refer to new-flow.http for a WebStorm HTTP client based example of API flow.

It is as follows:

```bash
curl 'https://stories-api-js.herokuapp.com/register' -H 'Content-Type: application/x-www-form-urlencoded' -H 'Origin: https://stories-api-js.herokuapp.com' --data-raw 'name=My Name&email=my{{$randomInt}}@email.com&password=12345'
```

/login when called with email and password returns

```json5
{
user: {...}
token: "..."
}
```

There on GET /stories/all can be called without the need to be authenticated to list all stories

GET /stories/all when called with Header
 `Authorization: Bearer {{token}}`
 returns an array of stories

```json5
[{"readCount":3,
"readBy":["5f5f43c6b018db001e35f13b","5f5fe5df8d1fbe001e81a4e8","5f5ec72956cf51001eeaad31"],
"_id":"5f5f0233488e1d001ee5aa63",
"title":"A",
"content":"sjci fdc djceijd",
"owner":"5f5ec72956cf51001eeaad31"}]
```

#### AUTHORIZED ROUTE

`GET /stories/{{ID}}` is an authenticated-only URL
As soon as an authenticated user hits the endpoint,
if it is the FIRST time they are visiting the story, then their user ID is added to readyBy array and stored in the database.

#### AUTHORIZED ROUTE

`POST /stories/{{ID}}` adds a new story to the database
It accepts the story content and title as parameters and returns a new story

```json
{"readCount":3,
"readBy":["5f5f43c6b018db001e35f13b","5f5fe5df8d1fbe001e81a4e8","5f5ec72956cf51001eeaad31"],
"_id":"5f5f0233488e1d001ee5aa63",
"title":"A",
"content":"sjci fdc djceijd",
"owner":"5f5ec72956cf51001eeaad31"}
```

#### AUTHORIZED ROUTE

Only the story owner can update a story
`PATCH /stories/{{ID}}` updates a existing story in the database
It accepts the story content and title as parameters and returns an updated story

```json
{"readCount":3,
"readBy":["5f5f43c6b018db001e35f13b","5f5fe5df8d1fbe001e81a4e8","5f5ec72956cf51001eeaad31"],
"_id":"5f5f0233488e1d001ee5aa63",
"title":"A",
"content":"sjci fdc djceijd",
"owner":"5f5ec72956cf51001eeaad31"}
```

#### AUTHORIZED ROUTE

Only the story owner can delete a story
`DELETE stories/{{ID}}` deletes a existing story in the database
